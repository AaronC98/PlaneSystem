<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.9. Concurrency and Ravenscar Profile &#8212; SPARK 2014 User&#39;s Guide 2019</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2019',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.10. SPARK Libraries" href="spark_libraries.html" />
    <link rel="prev" title="5.8. Object Oriented Programming and Liskov Substitution Principle" href="object_oriented_programming.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="spark_libraries.html" title="5.10. SPARK Libraries"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="object_oriented_programming.html" title="5.8. Object Oriented Programming and Liskov Substitution Principle"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SPARK 2014 User&#39;s Guide 2019</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../spark_2014.html" accesskey="U">5. Overview of SPARK Language</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.9. Concurrency and Ravenscar Profile</a><ul>
<li><a class="reference internal" href="#tasks-and-data-races">5.9.1. Tasks and Data Races</a><ul>
<li><a class="reference internal" href="#task-types-and-task-objects">5.9.1.1. Task Types and Task Objects</a></li>
<li><a class="reference internal" href="#preventing-data-races">5.9.1.2. Preventing Data Races</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-contracts">5.9.2. Task Contracts</a><ul>
<li><a class="reference internal" href="#data-dependencies">5.9.2.1. Data Dependencies</a></li>
<li><a class="reference internal" href="#flow-dependencies">5.9.2.2. Flow Dependencies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#protected-objects-and-deadlocks">5.9.3. Protected Objects and Deadlocks</a><ul>
<li><a class="reference internal" href="#protected-types-and-protected-objects">5.9.3.1. Protected Types and Protected Objects</a></li>
<li><a class="reference internal" href="#protected-subprograms">5.9.3.2. Protected Subprograms</a></li>
<li><a class="reference internal" href="#avoiding-deadlocks-and-priority-ceiling-protocol">5.9.3.3. Avoiding Deadlocks and Priority Ceiling Protocol</a></li>
</ul>
</li>
<li><a class="reference internal" href="#suspension-objects">5.9.4. Suspension Objects</a></li>
<li><a class="reference internal" href="#state-abstraction-and-concurrency">5.9.5. State Abstraction and Concurrency</a></li>
<li><a class="reference internal" href="#project-wide-tasking-analysis">5.9.6. Project-wide Tasking Analysis</a></li>
<li><a class="reference internal" href="#interrupt-handlers">5.9.7. Interrupt Handlers</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="object_oriented_programming.html"
                        title="previous chapter">5.8. Object Oriented Programming and Liskov Substitution Principle</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="spark_libraries.html"
                        title="next chapter">5.10. SPARK Libraries</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/en/source/concurrency.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="concurrency-and-ravenscar-profile">
<h1>5.9. Concurrency and Ravenscar Profile<a class="headerlink" href="#concurrency-and-ravenscar-profile" title="Permalink to this headline">¶</a></h1>
<p>Concurrency in SPARK requires enabling the Ravenscar profile (see <cite>Guide for
the use of the Ada Ravenscar Profile in high integrity systems</cite> by Alan Burns,
Brian Dobbing, and Tullio Vardanega). This profile defines a subset of the Ada
concurrency features suitable for hard real-time/embedded systems requiring
stringent analysis, such as certification and safety analyses. In particular,
it is concerned with determinism, analyzability, and memory-boundedness.</p>
<p>In addition to the subset defined by the Ravenscar profile, concurrency in SPARK
also requires that tasks do not start executing before
the program has been completely elaborated, which is expressed by setting
pragma <code class="docutils literal"><span class="pre">Partition_Elaboration_Policy</span></code> to the value <code class="docutils literal"><span class="pre">Sequential</span></code>. Together
with the requirement to apply the Ravenscar profile, this means that a concurrent
SPARK program should define the following configuration pragmas, either in a
configuration pragma file (see <a class="reference internal" href="../spark_mode.html#setting-the-default-spark-mode"><span class="std std-ref">Setting the Default SPARK_Mode</span></a> for an
example of defining a configuration pragma file in your project file) or at the
start of files:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Profile</span> <span class="o">(</span><span class="n">Ravenscar</span><span class="o">)</span><span class="p">;</span>
<span class="kr">pragma</span><span class="p"> </span><span class="n">Partition_Elaboration_Policy</span> <span class="o">(</span><span class="n">Sequential</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
<p>GNATprove also supports the GNAT Extended Ravenscar profile
(see Section 4.5 &#8220;The Extended Ravenscar Profiles&#8221; in GNAT User’s Guide
Supplement for GNAT Pro Safety-Critical and GNAT Pro High-Security).
To use the GNAT Extended Ravenscar profile simply replace <code class="docutils literal"><span class="pre">Ravenscar</span></code> with
<code class="docutils literal"><span class="pre">GNAT_Extended_Ravenscar</span></code> in the pragma <code class="docutils literal"><span class="pre">Profile</span></code> in the above code.
The extended profile is intended for hard real-time/embedded systems that may
require schedulability analysis but not the most stringent analyses required
for other domains.</p>
<p>In particular, to increase expressive power the GNAT Extended Ravenscar
profile relaxes certain restrictions defined by the standard Ravenscar profile.
Notably, these relaxed constraints allow multiple protected entries per
protected object, multiple queued callers per entry, and more expressive
protected entry barrier expressions. The profile also allows the use of
relative delay statements in addition to the absolute delay statements
allowed by Ravenscar. The two forms of delay statement are processed by
GNATprove based on the type of their expression, as follows (absolute and
relative delays, respectively):</p>
<ul class="simple">
<li>If the expression is of the type Ada.Real_Time.Time then for the purposes of
determining global inputs and outputs the absolute delay statement is considered
just like the relative delay statement, i.e., to reference the state abstraction
Ada.Real_Time.Clock_Time as an input (see SPARK RM 9(17) for details).</li>
<li>If the expression is of the type Ada.Calendar.Time then it is considered to
reference the state abstraction Ada.Calendar.Clock_Time, which is defined
similarly to Ada.Real_Time.Clock_Time but represents a different time base.</li>
</ul>
<div class="section" id="tasks-and-data-races">
<span id="id1"></span><h2>5.9.1. Tasks and Data Races<a class="headerlink" href="#tasks-and-data-races" title="Permalink to this headline">¶</a></h2>
<p>[Ravenscar]</p>
<p>Concurrent Ada programs are made of several <cite>tasks</cite>, that is, separate threads
of control which share the same address space. In Ravenscar, only
library-level, nonterminating tasks are allowed.</p>
<div class="section" id="task-types-and-task-objects">
<h3>5.9.1.1. Task Types and Task Objects<a class="headerlink" href="#task-types-and-task-objects" title="Permalink to this headline">¶</a></h3>
<p>Like ordinary objects, tasks have a type in Ada and can be stored in composite
objects such as arrays and records. The definition of a task type looks like
the definition of a subprogram. It is made of two parts: a declaration, usually
empty as Ravenscar does not allow tasks to have entries (for task rendezvous),
and a body containing the list of statements to be executed by objects of the
task type. The body of nonterminating tasks (the only ones allowed in
Ravenscar) usually takes the form of an infinite loop. For task objects of a
given type to be parameterized, task types can have discriminants. As an
example, a task type <code class="docutils literal"><span class="pre">Account_Management</span></code> can be declared as follows:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">loop</span><span class="p"></span>
         <span class="n">Get_Next_Account_Created</span><span class="p">;</span>
         <span class="n">Num_Accounts</span> <span class="o">:=</span> <span class="n">Num_Accounts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Account_Management</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>Then, tasks of type <code class="docutils literal"><span class="pre">Account_Management</span></code> can be created at library level,
either as complete objects or as components of other objects:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Bank</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Special_Accounts</span> <span class="o">:</span> <span class="n">Account_Management</span><span class="p">;</span>

   <span class="kr">type</span><span class="p"> </span><span class="n">Account_Type</span> <span class="kr">is</span><span class="p"> </span><span class="o">(</span><span class="n">Regular</span><span class="p">,</span> <span class="n">Premium</span><span class="p">,</span> <span class="n">Selective</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Account_Array</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="n">Account_Type</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
   <span class="n">All_Accounts</span> <span class="o">:</span> <span class="n">Account_Array</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Bank</span><span class="p">;</span>
</pre></div>
</div>
<p>If only one object of a given task type is needed, then the task object can be
declared directly giving a declaration and a body. An anonymous task type is
then defined implicitly for the declared type object. For example, if we only
need one task <code class="docutils literal"><span class="pre">Account_Management</span></code> then we can write:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">loop</span><span class="p"></span>
         <span class="n">Get_Next_Account_Created</span><span class="p">;</span>
         <span class="n">Num_Accounts</span> <span class="o">:=</span> <span class="n">Num_Accounts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Account_Management</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="preventing-data-races">
<span id="id2"></span><h3>5.9.1.2. Preventing Data Races<a class="headerlink" href="#preventing-data-races" title="Permalink to this headline">¶</a></h3>
<p>In Ravenscar, communication between tasks can only be done through shared
objects (tasks cannot communicate through rendezvous as task entries are not
allowed in Ravenscar). In SPARK, the language is further restricted to avoid
the possibility of erroneous concurrent access to shared data (a.k.a. data
races). More precisely, tasks can only share <cite>synchronized</cite> objects, that is,
objects that are protected against concurrent accesses. These include atomic
objects, protected objects (see <a class="reference internal" href="#protected-objects-and-deadlocks"><span class="std std-ref">Protected Objects and Deadlocks</span></a>), and
suspension objects (see <a class="reference internal" href="#suspension-objects"><span class="std std-ref">Suspension Objects</span></a>). As an example, our previous
definition of the <code class="docutils literal"><span class="pre">Account_Management</span></code> task type was not in SPARK. Indeed,
data races could occur when accessing the global variable <code class="docutils literal"><span class="pre">Num_Accounts</span></code>, as
detected by GNATprove:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>bank1.ads:5:04: high: possible data race when accessing variable &quot;account1.num_accounts&quot;
bank1.ads:5:04: high: with task &quot;bank1.all_accounts&quot;
bank1.ads:5:04: high: with task &quot;bank1.special_accounts&quot;
</pre></div>
</div>
<p>To avoid this problem, shared variable <code class="docutils literal"><span class="pre">Num_Account</span></code> can be declared atomic:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Atomic</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>With this modification, GNATprove now alerts us that the increment of
<code class="docutils literal"><span class="pre">Num_Account</span></code> is not legal, as a volatile variable (which is the case of
atomic variables) cannot be read as a subexpression of a larger expression in
SPARK:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>account2.adb:15:26: volatile object cannot appear in this context (SPARK RM 7.1.3(12))
</pre></div>
</div>
<p>This can be fixed by copying the current value of <code class="docutils literal"><span class="pre">Num_Account</span></code> in a
temporary before the increment:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="kr">declare</span><span class="p"></span>
   <span class="n">Tmp</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Natural</span> <span class="o">:=</span> <span class="n">Num_Accounts</span><span class="p">;</span>
<span class="kr">begin</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:=</span> <span class="n">Tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
<p>But note that even with that fix, there is no guarantee that <code class="docutils literal"><span class="pre">Num_Accounts</span></code> is
incremented by one each time an account is created. Indeed, two tasks may read
the same value of <code class="docutils literal"><span class="pre">Num_Accounts</span></code> and store this value in <code class="docutils literal"><span class="pre">Tmp</span></code> before both
updating it to <code class="docutils literal"><span class="pre">Tmp</span> <span class="pre">+</span> <span class="pre">1</span></code>. In such a case, two accounts have been created but
<code class="docutils literal"><span class="pre">Num_Accounts</span></code> has been increased by 1 only. There is no <cite>data race</cite> in this
program, which is confirmed by running GNATprove with no error, but there is
by design a <cite>race condition</cite> on shared data that causes the program to
malfunction. The correct way to fix this in SPARK is to use <a class="reference internal" href="#protected-types-and-protected-objects"><span class="std std-ref">Protected Types and Protected Objects</span></a>.</p>
<p>As they cannot cause data races, constants and variables that are constant after
elaboration (see <a class="reference internal" href="specification_features.html#aspect-constant-after-elaboration"><span class="std std-ref">Aspect Constant_After_Elaboration</span></a>) are considered as
synchronized and can be accessed by multiple tasks. For example, we can declare
a global constant <code class="docutils literal"><span class="pre">Max_Accounts</span></code> and use it inside <code class="docutils literal"><span class="pre">Account_Management</span></code>
without risking data races:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Atomic</span><span class="p">;</span>
   <span class="n">Max_Accounts</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Natural</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">loop</span><span class="p"></span>
         <span class="n">Get_Next_Account_Created</span><span class="p">;</span>
         <span class="kr">declare</span><span class="p"></span>
            <span class="n">Tmp</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Natural</span> <span class="o">:=</span> <span class="n">Num_Accounts</span><span class="p">;</span>
         <span class="kr">begin</span><span class="p"></span>
            <span class="kr">if</span><span class="p"> </span><span class="n">Tmp</span> <span class="o">&lt;</span> <span class="n">Max_Accounts</span> <span class="kr">then</span><span class="p"></span>
               <span class="n">Num_Accounts</span> <span class="o">:=</span> <span class="n">Tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">end if</span><span class="p">;</span>
         <span class="kr">end</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Account_Management</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>It is possible for a task to access an unsynchronized global variable only if
this variable is declared in the same package as the task and if there is a
single task accessing this variable. To allow this property to be statically
verified, only tasks of an anonymous task type are allowed to access
unsynchronized variables and the variables accessed should be declared to
belong to the task using aspect <code class="docutils literal"><span class="pre">Part_Of</span></code>. Global variables declared to
belong to a task are handled just like local variables of the task, that is,
they can only be referenced from inside the task body.  As an example, we can
state that <code class="docutils literal"><span class="pre">Num_Accounts</span></code> is only accessed by the task object
<code class="docutils literal"><span class="pre">Account_Management</span></code> in the following way:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">task</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>

   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Part_Of</span> <span class="o">=&gt;</span> <span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="task-contracts">
<h2>5.9.2. Task Contracts<a class="headerlink" href="#task-contracts" title="Permalink to this headline">¶</a></h2>
<p>[SPARK]</p>
<p>Dependency contracts can be specified on tasks. As tasks should not terminate
in SPARK, such contracts specify the dependencies between outputs and inputs
of the task <cite>updated while the task runs</cite>:</p>
<ul class="simple">
<li>The <cite>data dependencies</cite> introduced by aspect <code class="docutils literal"><span class="pre">Global</span></code> specify the global
data read and written by the task.</li>
<li>The <cite>flow dependencies</cite> introduced by aspect <code class="docutils literal"><span class="pre">Depends</span></code> specify how
task outputs depend on task inputs.</li>
</ul>
<p>This is a difference between tasks and subprograms, for which such contracts
describe the dependencies between outputs and inputs <cite>when the subprogram
returns</cite>.</p>
<div class="section" id="data-dependencies">
<h3>5.9.2.1. Data Dependencies<a class="headerlink" href="#data-dependencies" title="Permalink to this headline">¶</a></h3>
<p>Data dependencies on tasks follow the same syntax as the ones on subprograms
(see <a class="reference internal" href="subprogram_contracts.html#data-dependencies"><span class="std std-ref">Data Dependencies</span></a>). For example, data dependencies can be specified
for task (type or object) <code class="docutils literal"><span class="pre">Account_Management</span></code> as follows:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Atomic</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">with</span><span class="p"></span>
     <span class="n">Global</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">In_Out</span> <span class="o">=&gt;</span> <span class="n">Num_Accounts</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="flow-dependencies">
<h3>5.9.2.2. Flow Dependencies<a class="headerlink" href="#flow-dependencies" title="Permalink to this headline">¶</a></h3>
<p>Flow dependencies on tasks follow the same syntax as the ones on subprograms
(see <a class="reference internal" href="subprogram_contracts.html#flow-dependencies"><span class="std std-ref">Flow Dependencies</span></a>). For example, flow dependencies can be specified
for task (type or object) <code class="docutils literal"><span class="pre">Account_Management</span></code> as follows:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Atomic</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">with</span><span class="p"></span>
     <span class="n">Depends</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Account_Management</span> <span class="o">=&gt;</span> <span class="n">Account_Management</span><span class="p">,</span>
                 <span class="n">Num_Accounts</span>       <span class="o">=&gt;</span> <span class="n">Num_Accounts</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>Notice that the task unit itself is both an input and an output of the task:</p>
<ul class="simple">
<li>It is an input because task discriminants (if any) and task attributes may be
read in the task body.</li>
<li>It is an output so that the task unit may be passed as in out parameter in a
subprogram call. But note that the task object cannot be modified once
created.</li>
</ul>
<p>The dependency of the task on itself can be left implicit as well, as follows:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Atomic</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">with</span><span class="p"></span>
     <span class="n">Depends</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Num_Accounts</span> <span class="o">=&gt;</span> <span class="n">Num_Accounts</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="protected-objects-and-deadlocks">
<span id="id3"></span><h2>5.9.3. Protected Objects and Deadlocks<a class="headerlink" href="#protected-objects-and-deadlocks" title="Permalink to this headline">¶</a></h2>
<p>[Ravenscar]</p>
<p>In Ada, protected objects are used to encapsulate shared data and protect it
against data races (low-level unprotected concurrent access to data) and race
conditions (lack of proper synchronization between reads and writes of shared
data). They coordinate access to the protected data guaranteeing that
read-write accesses are always exclusive while allowing concurrent read-only
accesses. In Ravenscar, only library-level protected objects are allowed.</p>
<div class="section" id="protected-types-and-protected-objects">
<span id="id4"></span><h3>5.9.3.1. Protected Types and Protected Objects<a class="headerlink" href="#protected-types-and-protected-objects" title="Permalink to this headline">¶</a></h3>
<p>Definitions of protected types resemble package definitions. They are made of
two parts, a declaration (divided into a public part and a private part) and a
body. The public part of a protected type&#8217;s declaration contains the
declarations of the subprograms that can be used to access the data declared in
its private part. The body of these subprograms are located in the protected
type&#8217;s body. In Ravenscar, protected objects should be declared at library
level, either as complete objects or as components of other objects. As an
example, here is how a protected type can be used to coordinate concurrent
accesses to the global variable <code class="docutils literal"><span class="pre">Num_Accounts</span></code>:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Protected_Natural</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">Incr</span><span class="p">;</span>
      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span><span class="p">;</span>
   <span class="kr">private</span><span class="p"></span>
      <span class="n">The_Data</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Protected_Natural</span><span class="p">;</span>

   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Protected_Natural</span><span class="p">;</span>
   <span class="n">Max_Accounts</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Natural</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Protected_Natural</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">Incr</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">begin</span><span class="p"></span>
         <span class="n">The_Data</span> <span class="o">:=</span> <span class="n">The_Data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">end </span><span class="nf">Incr</span><span class="p">;</span>

      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span> <span class="kr">is</span><span class="p"> </span><span class="o">(</span><span class="n">The_Data</span><span class="o">)</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Protected_Natural</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">loop</span><span class="p"></span>
         <span class="n">Get_Next_Account_Created</span><span class="p">;</span>
         <span class="kr">if</span><span class="p"> </span><span class="n">Num_Accounts.Get</span> <span class="o">&lt;</span> <span class="n">Max_Accounts</span> <span class="kr">then</span><span class="p"></span>
            <span class="n">Num_Accounts.Incr</span><span class="p">;</span>
         <span class="k">end if</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Account_Management</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>Contrary to the previous version using an atomic global variable (see
<a class="reference internal" href="#preventing-data-races"><span class="std std-ref">Preventing Data Races</span></a>), this version prevents also any race condition
when incrementing the value of <code class="docutils literal"><span class="pre">Num_Accounts</span></code>. But note that there is still a
possible race condition between the time the value of <code class="docutils literal"><span class="pre">Num_Accounts</span></code> is read
and checked to be less than <code class="docutils literal"><span class="pre">Max_Accounts</span></code> and the time it is incremented. So
this version does not guarantee that <code class="docutils literal"><span class="pre">Num_Accounts</span></code> stays below
<code class="docutils literal"><span class="pre">Max_Accounts</span></code>. The correct way to fix this in SPARK is to use protected
entries (see <a class="reference internal" href="#protected-subprograms"><span class="std std-ref">Protected Subprograms</span></a>).</p>
<p>Note that, in SPARK, to avoid initialization issues on protected objects,
both private variables and variables belonging to a protected object must be
initialized at declaration (either explicitly or through default
initialization).</p>
<p>Just like for tasks, it is possible to directly declare a protected object if
it is the only one of its type. In this case, an anonymous protected type is
implicitly declared for it. For example, if <code class="docutils literal"><span class="pre">Num_Account</span></code> is the only
<code class="docutils literal"><span class="pre">Protected_Natural</span></code> we need, we can directly declare:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="n">Num_Accounts</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">Incr</span><span class="p">;</span>
      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span><span class="p">;</span>
   <span class="kr">private</span><span class="p"></span>
      <span class="n">The_Data</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Num_Accounts</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Num_Accounts</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">Incr</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">begin</span><span class="p"></span>
         <span class="n">The_Data</span> <span class="o">:=</span> <span class="n">The_Data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">end </span><span class="nf">Incr</span><span class="p">;</span>

      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span> <span class="kr">is</span><span class="p"> </span><span class="o">(</span><span class="n">The_Data</span><span class="o">)</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Num_Accounts</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="protected-subprograms">
<span id="id5"></span><h3>5.9.3.2. Protected Subprograms<a class="headerlink" href="#protected-subprograms" title="Permalink to this headline">¶</a></h3>
<p>The access mode granted by protected subprograms depends on their kind:</p>
<ul class="simple">
<li>Protected procedures provide exclusive read-write access to the private data
of a protected object.</li>
<li>Protected functions offer concurrent read-only access to the private data of
a protected object.</li>
<li>Protected <cite>entries</cite> are conceptually procedures with a <cite>barrier</cite>. When an
entry is called, the caller waits until the condition of the barrier is true
to be able to access the protected object.</li>
</ul>
<p>So that scheduling is deterministic, Ravenscar requires that at most one entry
is specified in a protected unit and at most one task is waiting on a given
entry at every time. To ensure this, GNATprove checks that no two tasks can
call the same protected object&#8217;s entry. As an example, we could replace the
procedure <code class="docutils literal"><span class="pre">Incr</span></code> of <code class="docutils literal"><span class="pre">Protected_Natural</span></code> to wait until <code class="docutils literal"><span class="pre">The_Data</span></code> is
smaller than <code class="docutils literal"><span class="pre">Max_Accounts</span></code> before incrementing it. As only simple Boolean
variables are allowed as entry barriers in Ravenscar, we add such a Boolean
flag <code class="docutils literal"><span class="pre">Not_Full</span></code> as a component of the protected object:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Protected_Natural</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">entry</span><span class="p"> </span><span class="n">Incr</span><span class="p">;</span>
      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span><span class="p">;</span>
   <span class="kr">private</span><span class="p"></span>
      <span class="n">The_Data</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">Not_Full</span> <span class="o">:</span> <span class="n">Boolean</span> <span class="o">:=</span> <span class="kc">True</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Protected_Natural</span><span class="p">;</span>

   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Protected_Natural</span><span class="p">;</span>
   <span class="n">Max_Accounts</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Natural</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Protected_Natural</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">entry</span><span class="p"> </span><span class="n">Incr</span> <span class="kr">when</span><span class="p"> </span><span class="n">Not_Full</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">begin</span><span class="p"></span>
         <span class="n">The_Data</span> <span class="o">:=</span> <span class="n">The_Data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
         <span class="kr">if</span><span class="p"> </span><span class="n">The_Data</span> <span class="o">=</span> <span class="n">Max_Accounts</span> <span class="kr">then</span><span class="p"></span>
            <span class="n">Not_Full</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>
         <span class="k">end if</span><span class="p">;</span>
      <span class="k">end </span><span class="nf">Incr</span><span class="p">;</span>

      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span> <span class="kr">is</span><span class="p"> </span><span class="o">(</span><span class="n">The_Data</span><span class="o">)</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Protected_Natural</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">loop</span><span class="p"></span>
         <span class="n">Get_Next_Account_Created</span><span class="p">;</span>
         <span class="n">Num_Accounts.Incr</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Account_Management</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>This version fixes the remaining race condition on this example, thus ensuring
that every new account created bumps the value of <code class="docutils literal"><span class="pre">Num_Accounts</span></code> by 1, and
that <code class="docutils literal"><span class="pre">Num_Accounts</span></code> stays below <code class="docutils literal"><span class="pre">Max_Accounts</span></code>.</p>
<p>To avoid data races, protected subprograms should not access unsynchronized
objects (see <a class="reference internal" href="#tasks-and-data-races"><span class="std std-ref">Tasks and Data Races</span></a>). Like for tasks, it is still possible
for subprograms of a protected object of an anonymous protected type to access
an unsynchronized object declared in the same package as long as it is not
accessed by any task or subprogram from other protected objects. In this case,
the unsynchronized object should have a <code class="docutils literal"><span class="pre">Part_Of</span></code> aspect referring to the
protected object. It is then handled as if it was a private variable of the
protected object. This is typically done so that the address in memory of the
variable can be specified, using either aspect <code class="docutils literal"><span class="pre">Address</span></code> or a corresponding
representation clause. Here is how this could be done with <code class="docutils literal"><span class="pre">Num_Account</span></code>:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">protected</span><span class="p"> </span><span class="n">Protected_Num_Accounts</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">Incr</span><span class="p">;</span>
      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Protected_Num_Accounts</span><span class="p">;</span>

   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"></span>
     <span class="n">Part_Of</span> <span class="o">=&gt;</span> <span class="n">Protected_Num_Accounts</span><span class="p">,</span>
     <span class="n">Address</span> <span class="o">=&gt;</span> <span class="o">...</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>As it can prevent access to a protected object for an unbounded amount of time,
a task should not be blocked or delayed while inside a protected subprogram.
Actions that can block a task are said to be <cite>potentially blocking</cite>. For
example, calling a protected entry, explicitly waiting using a <code class="docutils literal"><span class="pre">delay_until</span></code>
statement (note that <code class="docutils literal"><span class="pre">delay</span></code> statements are forbidden in Ravenscar), or
suspending on a suspension object (see <a class="reference internal" href="#suspension-objects"><span class="std std-ref">Suspension Objects</span></a>) are
potentially blocking actions. In Ada, it is an error to do a potentially
blocking action while inside a protected subprogram. Note that a call to a
function or a procedure on another protected object is not considered to be
potentially blocking. Indeed, such a call cannot block a task in the absence of
deadlocks (which is enforced in Ravenscar using the priority ceiling protocol,
see <a class="reference internal" href="#avoiding-deadlocks-and-priority-ceiling-protocol"><span class="std std-ref">Avoiding Deadlocks and Priority Ceiling Protocol</span></a>).</p>
<p>GNATprove verifies that no potentially blocking action is performed from
inside a protected subprogram in a modular way on a per subprogram basis.
Thus, if a subprogram can perform a potentially blocking operation, every call
to this subprogram from inside a protected subprogram will be flagged as a
potential error.  As an example, the procedure Incr_Num_Accounts is potentially
blocking and thus should not be called, directly or indirectly, from a
protected subprogram:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Protected_Natural</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">entry</span><span class="p"> </span><span class="n">Incr</span><span class="p">;</span>
   <span class="kr">private</span><span class="p"></span>
      <span class="n">The_Data</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Protected_Natural</span><span class="p">;</span>

   <span class="n">Num_Accounts</span> <span class="o">:</span> <span class="n">Protected_Natural</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">Incr_Num_Accounts</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="k">procedure </span><span class="nf">Incr_Num_Accounts</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Num_Accounts.Incr</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Incr_Num_Accounts</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="avoiding-deadlocks-and-priority-ceiling-protocol">
<span id="id6"></span><h3>5.9.3.3. Avoiding Deadlocks and Priority Ceiling Protocol<a class="headerlink" href="#avoiding-deadlocks-and-priority-ceiling-protocol" title="Permalink to this headline">¶</a></h3>
<p>To ensure exclusivity of read-write accesses, when a procedure or an entry of a
protected object is called, the protected object is locked so that no other
task can access it, be it in a read-write or a read-only mode. In the same way,
when a protected function is called, no other task can access the protected
object in read-write mode.  A <cite>deadlock</cite> happens when two or more tasks are
unable to run because each of them is trying to access a protected object that
is currently locked by another task.</p>
<p>To ensure absence of deadlocks on a single core, Ravenscar requires the use of
the Priority Ceiling Protocol. This protocol ensures that no task can be
blocked trying to access a protected object locked by another task.  It relies
on task&#8217;s <cite>priorities</cite>. The priority of a task is a number encoding its
urgency. On a single core, scheduling ensures that the current running task can
only be preempted by another task if it has a higher priority.  Using this
property, the Priority Ceiling Protocol works by increasing the priorities of
tasks accessing a protected object to a priority that is at least as high as
the priorities of other tasks accessing this object. This ensures that,
while holding a lock, the currently running task cannot be preempted by a task
which could later be blocked by this lock.</p>
<p>To enforce this protocol, every task is associated with a <cite>base priority</cite>,
either given at declaration using the <code class="docutils literal"><span class="pre">Priority</span></code> aspect or defaulted. This
base priority is static and cannot be modified after the task&#8217;s declaration. A
task also has an <cite>active priority</cite> which is initially the task&#8217;s base priority
but will be increased when the task enters a protected action.  For example, we
can set the base priority of <code class="docutils literal"><span class="pre">Account_Management</span></code> to 5 at declaration:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">with</span><span class="p"> </span><span class="n">Priority</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
<p>Likewise, each protected object is associated at declaration with a <cite>ceiling
priority</cite> which should be equal or higher than the active priority of any task
accessing it. The ceiling priority of a protected object does not need to be
static, it can be set using a discriminant for example. Still, like for tasks,
Ravenscar requires that it is set once and for all at the object&#8217;s declaration
and cannot be changed afterwards.  As an example, let us attach a ceiling
priority to the protected object <code class="docutils literal"><span class="pre">Num_Accounts</span></code>. As <code class="docutils literal"><span class="pre">Num_Accounts</span></code> will be
used by <code class="docutils literal"><span class="pre">Account_Management</span></code>, its ceiling priority should be no lower than 5:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Account</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">protected</span><span class="p"> </span><span class="n">Num_Accounts</span> <span class="kr">with</span><span class="p"> </span><span class="n">Priority</span> <span class="o">=&gt;</span> <span class="mi">7</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">Incr</span><span class="p">;</span>
      <span class="k">function </span><span class="nf">Get</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span><span class="p">;</span>
   <span class="kr">private</span><span class="p"></span>
      <span class="n">The_Data</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Num_Accounts</span><span class="p">;</span>

   <span class="kr">task</span><span class="p"> </span><span class="kr">type</span><span class="p"> </span><span class="n">Account_Management</span> <span class="kr">with</span><span class="p"> </span><span class="n">Priority</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>

<span class="k">end </span><span class="nf">Account</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="suspension-objects">
<span id="id7"></span><h2>5.9.4. Suspension Objects<a class="headerlink" href="#suspension-objects" title="Permalink to this headline">¶</a></h2>
<p>[Ravenscar]</p>
<p>The language-defined package <code class="docutils literal"><span class="pre">Ada.Synchronous_Task_Control</span></code> provides a type
for semaphores called <cite>suspension objects</cite>. They allow lighter synchronization
mechanisms than protected objects (see <a class="reference internal" href="#protected-objects-and-deadlocks"><span class="std std-ref">Protected Objects and Deadlocks</span></a>).
More precisely, a suspension object has a Boolean state which can be set
atomically to True using the <code class="docutils literal"><span class="pre">Set_True</span></code> procedure.  When a task suspends on a
suspension object calling the <code class="docutils literal"><span class="pre">Suspend_Until_True</span></code> procedure, it is blocked
until the state of the suspension object is True. At that point, the state of
the suspension object is set back to False and the task is unblocked. Note that
<code class="docutils literal"><span class="pre">Suspend_Until_True</span></code> is potentially blocking and therefore should not be
called directly or indirectly from within <a class="reference internal" href="#protected-subprograms"><span class="std std-ref">Protected Subprograms</span></a>.  In the
following example, the suspension object <code class="docutils literal"><span class="pre">Semaphore</span></code> is used to make sure
<code class="docutils literal"><span class="pre">T1</span></code> has initialized the shared data by the time <code class="docutils literal"><span class="pre">T2</span></code> begins processing it:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="n">Semaphore</span> <span class="o">:</span> <span class="n">Suspension_Object</span><span class="p">;</span>
<span class="kr">task</span><span class="p"> </span><span class="n">T1</span><span class="p">;</span>
<span class="kr">task</span><span class="p"> </span><span class="n">T2</span><span class="p">;</span>

<span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">T1</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
  <span class="n">Initialize_Shared_Data</span><span class="p">;</span>
  <span class="n">Set_True</span> <span class="o">(</span><span class="n">Semaphore</span><span class="o">)</span><span class="p">;</span>
  <span class="kr">loop</span><span class="p"></span>
    <span class="o">...</span>
  <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">T1</span><span class="p">;</span>

<span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">T2</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
  <span class="n">Suspend_Until_True</span> <span class="o">(</span><span class="n">Semaphore</span><span class="o">)</span><span class="p">;</span>
  <span class="kr">loop</span><span class="p"></span>
    <span class="o">...</span>
  <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">T2</span><span class="p">;</span>
</pre></div>
</div>
<p>In Ada, an exception is raised if a task tries to suspend on a suspension
object on which another task is already waiting on that same suspension
object. Like for verifying that no two tasks can be queued on a protected
entry, this verification is done by GNATprove by checking that no two tasks
ever suspend on the same suspension object.  In the following example, the
suspension objects <code class="docutils literal"><span class="pre">Semaphore1</span></code> and <code class="docutils literal"><span class="pre">Semaphore2</span></code> are used to ensure that
<code class="docutils literal"><span class="pre">T1</span></code> and <code class="docutils literal"><span class="pre">T2</span></code> never call <code class="docutils literal"><span class="pre">Enter_Protected_Region</span></code> at the same
time. GNATprove will successfully verify that only one task can suspend on
each suspension object:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="n">Semaphore1</span><span class="p">,</span> <span class="n">Semaphore2</span> <span class="o">:</span> <span class="n">Suspension_Object</span><span class="p">;</span>
<span class="kr">task</span><span class="p"> </span><span class="n">T1</span><span class="p">;</span>
<span class="kr">task</span><span class="p"> </span><span class="n">T2</span><span class="p">;</span>

<span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">T1</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
  <span class="kr">loop</span><span class="p"></span>
    <span class="n">Suspend_Until_True</span> <span class="o">(</span><span class="n">Semaphore1</span><span class="o">)</span><span class="p">;</span>
    <span class="n">Enter_Protected_Region</span><span class="p">;</span>
    <span class="n">Set_True</span> <span class="o">(</span><span class="n">Semaphore2</span><span class="o">)</span><span class="p">;</span>
  <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">T1</span><span class="p">;</span>

<span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">T2</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
  <span class="kr">loop</span><span class="p"></span>
    <span class="n">Suspend_Until_True</span> <span class="o">(</span><span class="n">Semaphore2</span><span class="o">)</span><span class="p">;</span>
    <span class="n">Enter_Protected_Region</span><span class="p">;</span>
    <span class="n">Set_True</span> <span class="o">(</span><span class="n">Semaphore1</span><span class="o">)</span><span class="p">;</span>
  <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">T2</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="state-abstraction-and-concurrency">
<span id="id8"></span><h2>5.9.5. State Abstraction and Concurrency<a class="headerlink" href="#state-abstraction-and-concurrency" title="Permalink to this headline">¶</a></h2>
<p>[SPARK]</p>
<p>Protected objects, as well as suspension objects, are <cite>effectively volatile</cite>
which means that their value as seen from a given task may change at any time
due to some other task accessing the protected object or suspension object. If
they are part of a state abstraction, the volatility of the abstract state must
be specified by using the <code class="docutils literal"><span class="pre">External</span></code> aspect (see <a class="reference internal" href="package_contracts.html#external-state-abstraction"><span class="std std-ref">External State Abstraction</span></a>). Note that task objects, though they can be part of a package&#8217;s
hidden state, are not effectively volatile and can therefore be components of
normal state abstractions. For example, the package
<code class="docutils literal"><span class="pre">Synchronous_Abstractions</span></code> defines two abstract states, one for external
objects, containing the atomic variable <code class="docutils literal"><span class="pre">V</span></code>, the suspension object <code class="docutils literal"><span class="pre">S</span></code>, and
the protected object <code class="docutils literal"><span class="pre">P</span></code>, and one for normal objects, containing the task
<code class="docutils literal"><span class="pre">T</span></code>:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Synchronous_Abstractions</span> <span class="kr">with</span><span class="p"></span>
  <span class="n">Abstract_State</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Normal_State</span><span class="p">,</span> <span class="o">(</span><span class="n">Synchronous_State</span> <span class="kr">with</span><span class="p"> </span><span class="n">External</span><span class="o">))</span>
<span class="kr">is</span><span class="p"></span>
<span class="k">end </span><span class="nf">Synchronous_Abstractions</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Synchronous_Abstractions</span> <span class="kr">with</span><span class="p"></span>
  <span class="n">Refined_State</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Synchronous_State</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">P</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">S</span><span class="o">)</span><span class="p">,</span> <span class="n">Normal_State</span> <span class="o">=&gt;</span> <span class="n">T</span><span class="o">)</span>
<span class="kr">is</span><span class="p"></span>
  <span class="kr">task</span><span class="p"> </span><span class="n">T</span><span class="p">;</span>

  <span class="n">S</span> <span class="o">:</span> <span class="n">Suspension_Object</span><span class="p">;</span>

  <span class="n">V</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">with</span><span class="p"> </span><span class="n">Atomic</span><span class="p">,</span> <span class="n">Async_Readers</span><span class="p">,</span> <span class="n">Async_Writers</span><span class="p">;</span>

  <span class="kr">protected</span><span class="p"> </span><span class="n">P</span> <span class="kr">is</span><span class="p"></span>
    <span class="k">function </span><span class="nf">Read</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span><span class="p">;</span>
  <span class="kr">private</span><span class="p"></span>
    <span class="n">V</span> <span class="o">:</span> <span class="n">Natural</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">end </span><span class="nf">P</span><span class="p">;</span>

  <span class="kr">protected</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">P</span> <span class="kr">is</span><span class="p"></span>
    <span class="k">function </span><span class="nf">Read</span> <span class="kr">return</span><span class="p"> </span><span class="n">Natural</span> <span class="kr">is</span><span class="p"> </span><span class="o">(</span><span class="n">V</span><span class="o">)</span><span class="p">;</span>
  <span class="k">end </span><span class="nf">P</span><span class="p">;</span>

  <span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">T</span> <span class="kr">is</span><span class="p"> </span><span class="o">...</span>
<span class="k">end  </span><span class="nf">Synchronous_Abstractions</span><span class="p">;</span>
</pre></div>
</div>
<p>To avoid data races, task bodies, as well as protected subprograms, should only
access synchronized objects (see <a class="reference internal" href="#preventing-data-races"><span class="std std-ref">Preventing Data Races</span></a>). State
abstractions containing only synchronized objects can be specified to be
synchronized using the <code class="docutils literal"><span class="pre">Synchronous</span></code> aspect. Only synchronized state
abstractions can be accessed from task bodies and protected subprograms. For
example, if we want the procedure <code class="docutils literal"><span class="pre">Do_Something</span></code> to be callable from the task
<code class="docutils literal"><span class="pre">Use_Synchronized_State</span></code>, then the state abstraction <code class="docutils literal"><span class="pre">Synchronous_State</span></code>
must be annotated using the <code class="docutils literal"><span class="pre">Synchronous</span></code> aspect:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">Synchronous_Abstractions</span> <span class="kr">with</span><span class="p"></span>
  <span class="n">Abstract_State</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Normal_State</span><span class="p">,</span>
                     <span class="o">(</span><span class="n">Synchronous_State</span> <span class="kr">with</span><span class="p"> </span><span class="n">Synchronous</span><span class="p">,</span> <span class="n">External</span><span class="o">))</span>
<span class="kr">is</span><span class="p"></span>
  <span class="k">procedure </span><span class="nf">Do_Something</span> <span class="kr">with</span><span class="p"> </span><span class="n">Global</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">In_Out</span> <span class="o">=&gt;</span> <span class="n">Synchronous_State</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Synchronous_Abstractions</span><span class="p">;</span>

<span class="kr">task</span><span class="p"> </span><span class="kr">body</span><span class="p"> </span><span class="n">Use_Synchronized_State</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
  <span class="kr">loop</span><span class="p"></span>
    <span class="n">Synchronous_Abstractions.Do_Something</span><span class="p">;</span>
  <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Use_Synchronized_State</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="project-wide-tasking-analysis">
<h2>5.9.6. Project-wide Tasking Analysis<a class="headerlink" href="#project-wide-tasking-analysis" title="Permalink to this headline">¶</a></h2>
<p>Tasking-related analysis, as currently implemented in GNATprove, is subject to
two limitations:</p>
<p>First, the analysis is always done when processing a source file with task
objects or with a subprogram that can be used as a main subprogram of a
partition (i.e. is at library level, has no parameters, and is either a
procedure or a function returning an integer type).</p>
<p>In effect, you might get spurious checks when:</p>
<ul class="simple">
<li>a subprogram satisfies conditions for being used as a main subprogram of a
partition but is not really used that way, i.e. it is not specified in the
Main attribute of the GNAT project file you use to build executables, and</li>
<li>it &#8220;withs&#8221; or is &#8220;withed&#8221; (directly or indirectly) from a library-level
package that declares some task object, and</li>
<li>both the fake &#8220;main&#8221; subprogram and the task object access the same resource in a
way that violates tasking-related rules (e.g. suspends on the same suspension
object).</li>
</ul>
<p>As a workaround, either wrap the fake &#8220;main&#8221; subprogram in a library-level package
or give it a dummy parameter.</p>
<p>Second, the analysis is only done in the context of all the units &#8220;withed&#8221;
(directly and indirectly) by the currently analyzed source file.</p>
<p>In effect, you might miss checks when:</p>
<ul class="simple">
<li>building a library that declares tasks objects in unrelated source files,
i.e. files that are never &#8220;withed&#8221; (directly or indirectly) from the same
file, and those tasks objects access the same resource in a way that violates
tasking-related rules, or</li>
<li>using a library that internally declares some tasks objects, they access some
tasking-sensitive resource, and your main subprogram also accesses this
resource.</li>
</ul>
<p>As a workaround, when building library projects add a dummy main subprogram
that &#8220;withs&#8221; all the library-level packages of your project.</p>
</div>
<div class="section" id="interrupt-handlers">
<h2>5.9.7. Interrupt Handlers<a class="headerlink" href="#interrupt-handlers" title="Permalink to this headline">¶</a></h2>
<p>SPARK puts no restrictions on the Ada interrupt handling and GNATprove merely
checks that interrupt handlers will be safely executed. In Ada interrupts
handlers are defined by annotating protected procedures, for example:</p>
<div class="highlight-ada"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Ada.Interrupts.Names</span><span class="p">; </span><span class="kr">use</span><span class="nn"> Ada.Interrupts.Names;</span>

<span class="kr">protected</span><span class="p"> </span><span class="n">P</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">procedure </span><span class="nf">Signal</span> <span class="kr">with</span><span class="p"> </span><span class="n">Attach_Handler</span> <span class="o">=&gt;</span> <span class="n">SIGINT</span><span class="p">;</span>
<span class="k">end </span><span class="nf">P</span><span class="p">;</span>
</pre></div>
</div>
<p>Currently GNATprove emits a check for each handler declaration saying that the
corresponding interrupt might be already reserved. In particular, it might be
reserved by either the system or the Ada runtime; see GNAT pragmas
Interrupt_State and Unreserve_All_Interrupts for details. Once examined, those
checks can be suppressed with pragma Annotate.</p>
<p>If pragma Priority or Interrupt_Priority is explicitly specified for a
protected type, then GNATprove will check that its value is in the range of the
System.Any_Priority or System.Interrupt_Priority, respectively; see Ada RM
D.3(6.1/3).</p>
<p>For interrupt handlers whose bodies are annotated with SPARK_Mode =&gt; On,
GNATprove will additionally check that:</p>
<ul class="simple">
<li>the interrupt handler does not call (directly or indirectly) the
Ada.Task_Identification.Current_Task routine, which might cause a
Program_Error runtime exception; see Ada RM C.7.1(17/3);</li>
<li>all global objects read (either as an Input or a Proof_In) by the interrupt
handler are initialized at elaboration;</li>
<li>there are no unsynchronized objects accessed both by the interrupt handler
and by some task (or by some other interrupt handler);</li>
<li>there are no protected objects locked both by the interrupt handler and by
some task (or by some other interrupt handler).</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="spark_libraries.html" title="5.10. SPARK Libraries"
             >next</a> |</li>
        <li class="right" >
          <a href="object_oriented_programming.html" title="5.8. Object Oriented Programming and Liskov Substitution Principle"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SPARK 2014 User&#39;s Guide 2019</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../spark_2014.html" >5. Overview of SPARK Language</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2019, AdaCore and Altran UK Ltd.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>